<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Redis Distop Manager</title>
    <!-- Basic -->
    <link rel="stylesheet" href="../../plugin/bootstrap/3.3.7/css/bootstrap.css">
    <link rel="stylesheet" href="../../plugin/toastr/toastr.min.css">
    <link rel="stylesheet" href="../../css/redisdesktopmanager/redis_desktop_manager.css">


    <script src="../../js/jquery-3.5.1.js"></script>
    <script src="../../plugin/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="../../plugin/toastr/toastr.min.js"></script>
    <script src="../../plugin/layer/3.1.1/layer.js"></script>
    <script src="../../js/common.js"></script>
    <script src="../../js/redisdesktopmanager/redis_desktop_manager.js"></script>

</head>
<body>
    <div class="container-fluid" style="padding-top: 10px;">
        <div  class="row" style="margin-bottom: 10px">
            <div class="col-md-3 col-sm-3">
                <button class="btn btn-default" onclick="openConnectionAdd('add')">添加连接</button>
            </div>
            <div class="col-md-9 col-sm-9">
                <a href="#" onclick="javascript:history.go(-1)" style="display: inline-block;float:right;">返回</a>
            </div>
        </div>
        <div  class="row">
            <div class="col-md-12 col-sm-12">
                <div  class="row">
                    <div class="col-md-3 col-sm-3" id="connectionList"></div>
                    <div class="col-md-3 col-sm-3" id="keyList">
                        <div class="row">
                            <div class="col-md-12 col-sm-12" style="margin-bottom: 10px;">
                                <table style="width: 100%;">
                                    <tbody>
                                        <tr><td>
                                            <input type="text" id="key" placeholder="请输入关键字">
                                        </td></tr>
                                        <tr>
                                            <td style="padding-top:5px;">
                                                <button class="btn btn-success" onclick="openDataAdd('add')">添加</button>
                                                <button class="btn btn-default" onclick="deleteKey()">删除</button>
                                                <button onclick="scan()" class="btn btn-info float-r" >搜索</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 col-sm-12" id="keyDiv"></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6">
                        <div class="row">
                            <div class="col-md-12 col-sm-12">
                                <table>
                                    <tbody>
                                        <tr>
                                            <td class="fontWeight900" id="kv-typeTD">TYPE：</td>
                                            <td style="width: 100%;padding-right: 5px;">
                                                <input type="text" class="float-r" id="kv-key" style="width: 100%;" readonly >
                                            </td>
                                            <td class="fontWeight900">TTL：</td>
                                            <td><input type="text" id="kv-ttl" class="float-r" style="width: 100px;" readonly >
                                                <input type="hidden" id="kv-type"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 10px;">
                            <div class="col-md-12 col-sm-12">
                                <div class="" id="kv-dataDiv">
                                    <textarea id="kv-value" style="width: 100%;min-height: 470px;resize:none;border: none;" ></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 10px; text-align: right;">
                            <div class="col-md-12 col-sm-12">
                                <button class="btn btn-primary float-l editorBtn listBtn margin-r-5" style="display: none;" onclick="kvTableAddRowByList('left')">头部新增</button>
                                <button class="btn btn-primary float-l editorBtn listBtn margin-r-5" style="display: none;" onclick="kvTableAddRowByList('right')">尾部新增</button>

                                <button class="btn btn-primary float-l editorBtn setBtn margin-r-5" style="display: none;" onclick="kvTableAddRowByList('right')">新增</button>

                                <button class="btn btn-primary float-l editorBtn zsetBtn margin-r-5" style="display: none;" onclick="kvTableAddRowByZset()">新增</button>

                                <button class="btn btn-default float-l editorBtn listBtn setBtn zsetBtn hashBtn" style="display: none;" onclick="kvTableRemoveRow()" >删除</button>

                                <button class="btn btn-default" onclick="loadKeyValueChildren()">刷新</button>
                                <button class="btn btn-success" onclick="editKey()">保存</button>
                            </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-12 col-sm-12">
<!--            <button class="btn btn-default">btn-default</button>-->
<!--            <button class="btn btn-link">btn-link</button>-->
<!--            <button class="btn btn-info">btn-info</button>-->
<!--            <button class="btn btn-primary">btn-primary</button>-->
<!--            <button class="btn btn-success">btn-success</button>-->
<!--            <button class="btn btn-danger">btn-danger</button>-->
<!--            <button class="btn btn-warning">btn-warning</button>-->
<!--            <button class="btn btn-block">btn-block</button>-->
        </div>

    </div>

<script>

    $(function(){
        load();
    });

    function openConnectionAdd(type,id){
        var title = "添加连接";
        if (type == "edit") {
            title = "编辑连接";
        }
        layer.open({
            type: 2,
            title: title,
            maxmin: true,
            // shadeClose: true, //点击遮罩关闭层
            area : ['400px' , '420px'],
            content: "redis_desktop_manager_connection_edit.html?csId="+id,
            end:function () {
                load();
            }
        });
    }

    // 删除连接
    function deleteConnection(csId) {
        var _i = layer.confirm('确认删除该连接吗？', {
            btn: ['确认', '取消']
        }, function(index, layero){
            loading();
            $.ajax({
                url:"../../redisDesktopManager/delete?tm="+ new Date().getTime(),
                type:"POST",
                data:{
                    csId:csId
                },
                dataType:"JSON",
                success:function (res) {
                    if(res.code == 200){
                        message.success();
                        load();
                    } else {
                        message.error(res.message);
                    }
                },error:function (res) {
                    message.error();
                },complete(XHR, TS) {
                    loadingClose();
                    layer.close(_i);
                }
            });
        });
    }

    // 加载连接列表
    function load(){
        $.ajax({
            url:"../../redisDesktopManager/findConnectionByUserId?tm="+ new Date().getTime(),
            type:"POST",
            dataType:"JSON",
            success:function (res) {
                $("#connectionList").html("");
                if (res.code == 200) {
                    $.each(res.data,function(i,temp){
                        var html = '<div onclick="connectionSelected(this)" ondblclick="connectionRedis('+temp.csId+',this)"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> '
                            + temp.connectionName +
                            '   <div class="editor">' +
                            '       <span class="glyphicon glyphicon-edit" aria-hidden="true" onclick="openConnectionAdd(\'edit\','+temp.csId+')"></span>' +
                            '       <span class="glyphicon glyphicon-trash" aria-hidden="true" onclick="deleteConnection('+temp.csId+')"></span>' +
                            '   </div>'+
                            '</div>';

                        $("#connectionList").append(html);
                    });
                }
            },error:function (res) {
                message.error();
            }
        });
    }

    // 选择连接
    function connectionSelected(_this){
        $(".selectedItem > .editor").removeClass("display-inline");
        $(".selectedItem").removeClass("selectedItem");
        $(_this).addClass("selectedItem");
        $(_this).find(".editor").addClass("display-inline");

        var _currentSelectConnection = $(_this).data("connectionKey");
        if (strNotNull(_currentSelectConnection)) {
            currentSelectConnection = _currentSelectConnection;
            currentSelectConnectionName = $(_this).data("connectionName");
        }

    }

    var currentSelectConnection;
    var currentSelectConnectionName;
    function connectionRedis(csId,_this){
        var connectionKey = $(_this).data("connectionKey");
        if (strNotNull(connectionKey)) {
            return ;
        }
        loading();
        $.ajax({
            url:"../../redisDesktopManager/connectionRedis?tm="+ new Date().getTime(),
            type:"POST",
            data:{
                "csId":csId
            },
            dataType:"JSON",
            success:function (res) {
                if (res.code == 200) {
                    $(_this).next("ul").remove();
                    var html = '<ul>';
                    $.each(res.data.list,function(i,temp){
                        html += '<li class="databaseLi" onclick="selectDB('+i+',this)">'+temp.dbName+'('+temp.size+')</li>';
                    });
                    html += '</ul>';
                    $(_this).after(html);
                    $(_this).data("connectionKey",res.data.connectionKey);
                    $(_this).data("connectionName",res.data.connectionName);
                    currentSelectConnection = res.data.connectionKey
                    currentSelectConnectionName = res.data.connectionName

                    $(_this).prepend('<span class="glyphicon glyphicon-triangle-bottom" style="cursor: pointer;" onclick="showHideDatabase(this)" aria-hidden="true">');
                }
            },error:function (res) {
                message.error();
            },complete(XHR, TS) {
                loadingClose();
            }
        });
    }
    // 显示、隐藏databases
    function showHideDatabase(_this){
        if ($(_this).hasClass("glyphicon-triangle-bottom")) {
            $(_this).parent().next("ul").hide();
            $(_this).removeClass("glyphicon-triangle-bottom");
            $(_this).addClass("glyphicon-triangle-right");
        } else {
            $(_this).parent().next("ul").show();
            $(_this).removeClass("glyphicon-triangle-right");
            $(_this).addClass("glyphicon-triangle-bottom");
        }
    }

    var currentDBIndex;
    function selectDB(index,_this){
        $(".selectedItem > .editor").removeClass("display-inline");
        $(".selectedItem").removeClass("selectedItem");
        $(_this).addClass("selectedItem");
        $(_this).find(".editor").addClass("display-inline");
        currentDBIndex = index;
        // 加载key
        $("#key").val("*");
        scan();
        // 删除keyValueDiv
        $("#kv-dataDiv").html("");
    }

    function scan(){
        var key = $("#key").val();
        if (!strNotNull(key)) {
            key = "*";
        }
        loading();
        $.ajax({
            url:"../../redisDesktopManager/scan?tm="+ new Date().getTime(),
            type:"POST",
            data:{
                connectionKey:currentSelectConnection,
                dbIndex:currentDBIndex,
                key:key
            },
            dataType:"JSON",
            success:function (res) {
                if (res.code == 200) {
                    $("#keyDiv").html("");
                    var html = '';
                    $.each(res.data,function(i,temp){
                        var _cls = '';
                        if (i%2 == 0) {
                            _cls = 'color-bg-fa';
                        }
                       // html += '<tr><td>'+(i+1)+'</td><td '+_cls+'>'+temp+'</td></tr>';
                        html += '<div title="'+temp+'" onclick="loadKeyValue(\''+temp+'\',this)" class="col-md-12 col-sm-12 '+_cls+'" >'+temp+'</div>';
                    });
                    $("#keyDiv").html(html);
                }
            },error:function (res) {
                message.error();
            },complete(XHR, TS) {
                loadingClose();
            }
        });
    }

    function loadKeyValue(key,_this) {
        loading();
        $(".color-bg-e8f2ff").removeClass("color-bg-e8f2ff");
        $(_this).addClass("color-bg-e8f2ff");
        loadKeyValueChildren(key);
    }

    function loadKeyValueChildren(key) {
        if (!strNotNull(key)) {
            key = $("#kv-key").val();
        }
        if (!strNotNull(key)) {
            return ;
        }
        loading();
        $.ajax({
            url:"../../redisDesktopManager/loadKeyValue?tm="+ new Date().getTime(),
            type:"POST",
            data:{
                connectionKey:currentSelectConnection,
                dbIndex:currentDBIndex,
                key:key
            },
            dataType:"JSON",
            success:function (res) {
                if (res.code == 200) {
                    // 前置操作
                    $(".editorBtn").hide();
                    $("#kv-dataDiv").html("");
                    editArr = new Array();

                    var html = '';
                    var type = res.data.type;
                    if ("string" == type) {
                        html = '<textarea id="kv-value" style="width: 100%;min-height: 470px;resize:none;border: none;" >'+res.data.data+'</textarea>';
                    } else if ("list" == type || "set" == type) {
                        html += '<table class="width-full kv-data-tab" border="1">' +
                            '       <thead><tr><td style="width: 35px;"></td><td>值</td></tr></thead>' +
                            '       <tbody>';
                        $.each(res.data.data,function(i,temp){
                            html += '<tr><td class="text-c" onclick="selectKVTabRow(this)">'+(i+1)+'</td><td class="kv-data-tab-row" onclick="transformInput(\'textarea\',this)">'+temp+'</td></tr>';
                        });
                        html += '   </tbody></table>';
                        if ("list" == type) {
                            $(".listBtn").show();
                        } else {
                            $(".setBtn").show();
                        }
                    } else if ("zset" == type) {
                        html += '<table class="width-full kv-data-tab"  border="1">' +
                            '       <thead><tr><td style="width: 35px;"></td><td>Value</td><td style="width: 150px;">Score</td></tr></thead>' +
                            '       <tbody>';
                        $.each(res.data.data,function(i,temp){
                            html += '<tr><td class="text-c" onclick="selectKVTabRow(this)">'+(i+1)+'</td>' +
                                '<td class="kv-data-tab-row" onclick="transformInput(\'textarea\',this)">'+temp.element+'</td>' +
                                '<td class="kv-data-tab-row" onclick="transformInput(\'number\',this)">'+temp.score+'</td></tr>';
                        });
                        html += '   </tbody></table>';
                        $(".zsetBtn").show();
                    } else if ("hash" == type) {
                        html += '<table class="width-full kv-data-tab" border="1">' +
                            '       <thead><tr><td style="width: 35px;"></td><td style="width: 200px;">Key</td><td>Value</td></tr></thead>' +
                            '       <tbody>';
                        $.each(res.data.data,function(i,temp){
                            for (var key in temp) {
                                html += '<tr><td class="text-c" onclick="selectKVTabRow(this)">'+(i+1)+'</td>' +
                                    '<td class="kv-data-tab-row" onclick="transformInput(\'textarea\',this)">'+key+'</td>' +
                                    '<td class="kv-data-tab-row" onclick="transformInput(\'textarea\',this)">'+temp[key]+'</td></tr>';
                            }
                        });
                        html += '   </tbody></table>';
                        $(".hashBtn").show();
                    }
                    $("#kv-dataDiv").html(html);

                    $("#kv-key").val(res.data.key);
                    $("#kv-type").val(type);
                    $("#kv-typeTD").html(type.toUpperCase()+"：");
                    $("#kv-ttl").val(res.data.ttl);
                }
            },error:function (res) {
                message.error();
            },complete(XHR, TS) {
                loadingClose();
            }
        });
    }

    // 打开添加数据界面
    function openDataAdd(type,id){
        if (!strNotNull(currentSelectConnectionName)) {
            message.warning("请先选择连接");
            return;
        }
        if (!strNotNull(currentDBIndex)) {
            message.warning("请选择数据库");
            return;
        }
        layer.open({
            type: 2,
            title: "添加数据到【"+currentSelectConnectionName+":db"+currentDBIndex+"】",
            maxmin: true,
            // shadeClose: true, //点击遮罩关闭层
            area : ['800px' , '620px'],
            content: "redis_desktop_manager_data_add.html?csId="+currentSelectConnection+"&dbIndex="+currentDBIndex,
            end:function () {
                scan();
            }
        });
    }

    // 删除键
    function deleteKey() {
        var len = $(".color-bg-e8f2ff").length;
        if (len <= 0) {
            message.warning("请选择Key");
            return ;
        }
        var key = $(".color-bg-e8f2ff:eq(0)").html();
        var _i = layer.confirm('确认删除【'+key+'】吗？', {
            btn: ['确认', '取消']
        }, function(index, layero){
            loading();
            $.ajax({
                url:"../../redisDesktopManager/deleteKey?tm="+ new Date().getTime(),
                type:"POST",
                data:{
                    csId:currentSelectConnection,
                    dbIndex:currentDBIndex,
                    key:key
                },
                dataType:"JSON",
                success:function (res) {
                    if (res.code == 200) {
                        message.success();
                        $("#kv-dataDiv").html("");
                        scan();
                    }
                },error:function (res) {
                    message.error();
                },complete(XHR, TS) {
                    loadingClose();
                    layer.close(_i);
                }
            });
        });
    }
    // 编辑操作对象集合
    var editArr;
    // 编辑KEY
    function editKey(){
        var key = $("#kv-key").val();
        var type = $("#kv-type").val();
        var ttl = $("#kv-ttl").val();
        var value = "";
        var tempEditArr = new Array();
        if (editArr.length > 0) {
            $.each(editArr,function (i,temp){
               tempEditArr.push(temp);
            });
        }
        if ("string" == type) {
            value = $("#kv-value").val();
        } else {
            if ("list" == type || "set" == type) {
                // editArr
                $("#kv-dataDiv table tbody tr").each(function (i,temp){
                    var _type = $(temp).data("type");
                    var _value = $(temp).find("td:eq(1)").html();
                    if (!strNotNull(_type)) {
                        // 原来的值
                        var _oldValue = $(temp).data("old_value");
                        // 是否修改过
                        if (undefined != _oldValue && _oldValue != _value) {
                            var editData = {
                                type:"set",
                                oldValue:_oldValue,
                                value:_value,
                                index:i
                            }
                            editArr.push(editData);
                        }
                    } else {
                        // 新值
                        var editData = {
                            type:_type,
                            value:_value
                        }
                        editArr.push(editData);
                    }
                });
            } else if ("zset" == type) {
                $("#kv-dataDiv table tbody tr").each(function (i,temp){
                    var _type = $(temp).data("type");
                    var _value = $(temp).find("td:eq(1)").html();
                    var _score = $(temp).find("td:eq(2)").html();
                    if (!strNotNull(_type)) {
                        // 原来的值
                        var _oldValue = $(temp).data("old_value");
                        // 是否修改过
                        if (undefined != _oldValue && _oldValue != _value) {
                            var editData = {
                                type:"set",
                                oldValue:_oldValue,
                                value:_value,
                                score:_score
                            }
                            editArr.push(editData);
                        }
                    } else {
                        // 新值
                        var editData = {
                            type:_type,
                            value:_value,
                            score:_score
                        }
                        editArr.push(editData);
                    }

                });
            } else if ("hash" == type) {
                $("#kv-dataDiv table tbody tr").each(function (i,temp){
                    var _type = $(temp).data("type");
                    var _value = $(temp).find("td:eq(1)").html();
                    var fieldValue = $(temp).find("td:eq(2)").html();
                    if (!strNotNull(_type)) {
                        // 原来的值
                        var oldHashKey = $(temp).data("old_value");
                        // 是否修改过
                        if (undefined != _oldValue && _oldValue != _value) {
                            var editData = {
                                type:"set",
                                value:_value,
                                oldHashKey:oldHashKey,
                                fieldValue:fieldValue
                            }
                            editArr.push(editData);
                        }
                    } else {
                        // 新值
                        var editData = {
                            type:_type,
                            value:_value,
                            fieldValue:fieldValue
                        }
                        editArr.push(editData);
                    }
                });
            }

            if (editArr.length <= 0) {
                message.warning("没有任何修改!");
                return ;
            }
            console.info(editArr);
            value = JSON.stringify(editArr);
        }
        var _i = layer.confirm('确认修改吗？', {
            btn: ['确认', '取消'],
            cancel:function (index, layero){
                // 右上角
                editArr = tempEditArr;
            }
        }, function(index, layero){
            loading();
            $.ajax({
                url:"../../redisDesktopManager/editKey?tm="+ new Date().getTime(),
                type:"POST",
                data:{
                    csId:currentSelectConnection,
                    dbIndex:currentDBIndex,
                    key:key,
                    type:type,
                    ttl:ttl,
                    value:value
                },
                dataType:"JSON",
                success:function (res) {
                    if (res.code == 200) {
                        message.success();
                        loadKeyValueChildren();
                    }
                },error:function (res) {
                    message.error();
                },complete(XHR, TS) {
                    loadingClose();
                    layer.close(_i);
                }
            });
        },function(index, layero){
            // 取消按钮
            editArr = tempEditArr;
        });
    }
    // 添加行 LIST
    function kvTableAddRowByList(type){
        var html = '<tr data-type="'+type+'">' +
            '           <td class="text-c"></td>' +
            '           <td class="kv-data-tab-row" onclick="transformInput(\'textarea\',this)"></td>' +
            '       </tr>';
        if ("left" == type) {
            $("#kv-dataDiv table tbody").prepend(html);
        } else {
            $("#kv-dataDiv table tbody").append(html);
        }
        $("#kv-dataDiv table tbody tr").each(function (i,temp){
            $(this).children("td:eq(0)").html(i+1);
        });
    }
    // 添加行 ZSET
    function kvTableAddRowByZset() {
        var html = '<tr data-type="add">' +
            '           <td class="text-c"></td>' +
            '           <td onclick="transformInput(\'textarea\',this)"></td>' +
            '           <td onclick="transformInput(\'number\',this)"></td>' +
            '       </tr>';
        $("#kv-dataDiv table tbody").prepend(html);
        $("#kv-dataDiv table tbody tr").each(function (i,temp){
            $(this).children("td:eq(0)").html(i+1);
        });
    }
    // 删除行
    function kvTableRemoveRow(){
        var obj = null;
        if ($("#kv-dataDiv table").find(".color-bg-ef").length > 0) {
            obj = $("#kv-dataDiv table").find(".color-bg-ef")[0];
        } else {
            message.warning("请选择行！");
            return;
        }

        // editArr
        var kv_type = $("#kv-type").val();
        var objType = $(obj).data("type");
        if (!strNotNull(objType)) {
            var _index = $(obj).index();
            var _sum = $("#kv-dataDiv table tbody tr").length;
            // 原来的值
            var editData = {
                type:"rem",
                count:(_index > _sum / 2)?"-1":"1",
                value:$(obj).find("td:eq(1)").html()
            }
            editArr.push(editData);
        }

        // remove
        $(obj).remove();

        // re index
        $("#kv-dataDiv table tbody tr").each(function (i,temp){
            $(this).children("td:eq(0)").html(i+1);
        });
    }
    // 选择行 TR
    function selectKVTabRow(_this) {
        $("#kv-dataDiv").find(".color-bg-ef").removeClass("color-bg-ef");
        $(_this).parent().addClass("color-bg-ef");
    }

    var transformIndex = 0;
    function transformInput(type,_this){
        // 选择该行
        selectKVTabRow(_this);

        // 验证
        if ($(_this).find(type).length > 0) {
            return ;
        }

        // 唯一ID
        transformIndex++;
        var uuid = "transformIndex_"+transformIndex;

        // 原值
        var val = $(_this).html();
        var isInitData = $(_this).parent().data("is_init_data");
        if (!strNotNull(isInitData) || isInitData != "1") {
            $(_this).parent().data("is_init_data","1");
            $(_this).parent().data("old_value",val);
        }

        // HTML
        var html = "";
        if ("textarea" == type) {
            html = '<textarea class="table-textarea" id="'+uuid+'" style="height:'+$(_this).height()+'px"></textarea>';
        } else if ("number" == type) {
            html = '<input type="number" id="'+uuid+'"></input>';
        }
        $(_this).html(html);
        $("#"+uuid).val(val);
        $("#"+uuid).focus()
        $("#"+uuid).on("blur",function (){
            var val = $(this).val();
            $(this).parent().html(val);
        });

    }




</script>
</body>
</html>