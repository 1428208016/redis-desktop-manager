<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Redis Distop Manager</title>
    <!-- Basic -->
    <link rel="stylesheet" href="../../plugin/bootstrap/3.3.7/css/bootstrap.css">
    <link rel="stylesheet" href="../../plugin/toastr/toastr.min.css">
    <link rel="stylesheet" href="../../css/redis_desktop_manager.css">


    <script src="../../js/jquery-3.5.1.js"></script>
    <script src="../../plugin/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="../../plugin/toastr/toastr.min.js"></script>
    <script src="../../plugin/layer/3.1.1/layer.js"></script>
    <script src="../../js/common.js"></script>

</head>
<body>
    <div class="container-fluid" style="padding-top: 10px;">
        <div  class="row" style="margin-bottom: 10px">
            <div class="col-md-3 col-sm-3">
                <button class="btn btn-default" onclick="openConnectionAdd('add')">添加连接</button>
            </div>
            <div class="col-md-9 col-sm-9">
                <a href="#" onclick="javascript:history.go(-1)" style="display: inline-block;float:right;">返回</a>
            </div>
        </div>
        <div  class="row">
            <div class="col-md-12 col-sm-12">
                <div  class="row">
                    <div class="col-md-3 col-sm-3" id="connectionList"></div>
                    <div class="col-md-3 col-sm-3" id="keyList">
                        <div class="row">
                            <div class="col-md-12 col-sm-12" style="margin-bottom: 10px;">
                                <table style="width: 100%;">
                                    <tbody>
                                        <tr><td>
                                            <input type="text" id="key" placeholder="请输入关键字">
                                        </td></tr>
                                        <tr>
                                            <td style="padding-top:5px;">
                                                <button class="btn btn-success" onclick="openDataAdd('add')">添加</button>
                                                <button class="btn btn-default" onclick="deleteKey()">删除</button>
                                                <button onclick="scan()" class="btn btn-info float-r" >搜索</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 col-sm-12" id="keyDiv"></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6" id="keyValueDiv"></div>
                </div>
            </div>
        </div>


        <div class="col-md-12 col-sm-12">
<!--            <button class="btn btn-default">btn-default</button>-->
<!--            <button class="btn btn-link">btn-link</button>-->
<!--            <button class="btn btn-info">btn-info</button>-->
<!--            <button class="btn btn-primary">btn-primary</button>-->
<!--            <button class="btn btn-success">btn-success</button>-->
<!--            <button class="btn btn-danger">btn-danger</button>-->
<!--            <button class="btn btn-warning">btn-warning</button>-->
<!--            <button class="btn btn-block">btn-block</button>-->
        </div>

    </div>

<script>

    $(function(){
        load();
    });

    function openConnectionAdd(type,id){
        var title = "添加连接";
        if (type == "edit") {
            title = "编辑连接";
        }
        layer.open({
            type: 2,
            title: title,
            maxmin: true,
            // shadeClose: true, //点击遮罩关闭层
            area : ['400px' , '420px'],
            content: "redis_desktop_manager_connection_edit.html?csId="+id,
            end:function () {
                load();
            }
        });
    }

    // 删除连接
    function deleteConnection(csId) {
        var _i = layer.confirm('确认删除该连接吗？', {
            btn: ['确认', '取消']
        }, function(index, layero){
            loading();
            $.ajax({
                url:"../../redisDesktopManager/delete?tm="+ new Date().getTime(),
                type:"POST",
                data:{
                    csId:csId
                },
                dataType:"JSON",
                success:function (res) {
                    if(res.code == 200){
                        message.success();
                        load();
                    } else {
                        message.error(res.message);
                    }
                },error:function (res) {
                    message.error();
                },complete(XHR, TS) {
                    loadingClose();
                    layer.close(_i);
                }
            });
        });
    }

    // 加载连接列表
    function load(){
        $.ajax({
            url:"../../redisDesktopManager/findConnectionByUserId?tm="+ new Date().getTime(),
            type:"POST",
            dataType:"JSON",
            success:function (res) {
                $("#connectionList").html("");
                if (res.code == 200) {
                    $.each(res.data,function(i,temp){
                        var html = '<div onclick="connectionSelected(this)" ondblclick="connectionRedis('+temp.csId+',this)"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> '
                            + temp.connectionName +
                            '   <div class="editor">' +
                            '       <span class="glyphicon glyphicon-edit" aria-hidden="true" onclick="openConnectionAdd(\'edit\','+temp.csId+')"></span>' +
                            '       <span class="glyphicon glyphicon-trash" aria-hidden="true" onclick="deleteConnection('+temp.csId+')"></span>' +
                            '   </div>'+
                            '</div>';

                        $("#connectionList").append(html);
                    });
                }
            },error:function (res) {
                message.error();
            }
        });
    }

    // 选择连接
    function connectionSelected(_this){
        $(".selectedItem > .editor").removeClass("display-inline");
        $(".selectedItem").removeClass("selectedItem");
        $(_this).addClass("selectedItem");
        $(_this).find(".editor").addClass("display-inline");

        var _currentSelectConnection = $(_this).data("connectionKey");
        if (strNotNull(_currentSelectConnection)) {
            currentSelectConnection = _currentSelectConnection;
            currentSelectConnectionName = $(_this).data("connectionName");
        }

    }

    var currentSelectConnection;
    var currentSelectConnectionName;
    function connectionRedis(csId,_this){
        var connectionKey = $(_this).data("connectionKey");
        if (strNotNull(connectionKey)) {
            return ;
        }
        loading();
        $.ajax({
            url:"../../redisDesktopManager/connectionRedis?tm="+ new Date().getTime(),
            type:"POST",
            data:{
                "csId":csId
            },
            dataType:"JSON",
            success:function (res) {
                if (res.code == 200) {
                    $(_this).next("ul").remove();
                    var html = '<ul>';
                    $.each(res.data.list,function(i,temp){
                        html += '<li class="databaseLi" onclick="selectDB('+i+',this)">'+temp.dbName+'('+temp.size+')</li>';
                    });
                    html += '</ul>';
                    $(_this).after(html);
                    $(_this).data("connectionKey",res.data.connectionKey);
                    $(_this).data("connectionName",res.data.connectionName);
                    currentSelectConnection = res.data.connectionKey
                    currentSelectConnectionName = res.data.connectionName

                    $(_this).prepend('<span class="glyphicon glyphicon-triangle-bottom" style="cursor: pointer;" onclick="showHideDatabase(this)" aria-hidden="true">');
                }
            },error:function (res) {
                message.error();
            },complete(XHR, TS) {
                loadingClose();
            }
        });
    }
    // 显示、隐藏databases
    function showHideDatabase(_this){
        if ($(_this).hasClass("glyphicon-triangle-bottom")) {
            $(_this).parent().next("ul").hide();
            $(_this).removeClass("glyphicon-triangle-bottom");
            $(_this).addClass("glyphicon-triangle-right");
        } else {
            $(_this).parent().next("ul").show();
            $(_this).removeClass("glyphicon-triangle-right");
            $(_this).addClass("glyphicon-triangle-bottom");
        }
    }

    var currentDBIndex;
    function selectDB(index,_this){
        $(".selectedItem > .editor").removeClass("display-inline");
        $(".selectedItem").removeClass("selectedItem");
        $(_this).addClass("selectedItem");
        $(_this).find(".editor").addClass("display-inline");
        currentDBIndex = index;
        // 加载key
        $("#key").val("*");
        scan();
        // 删除keyValueDiv
        $("#keyValueDiv").html("");
    }

    function scan(){
        var key = $("#key").val();
        if (!strNotNull(key)) {
            key = "*";
        }
        loading();
        $.ajax({
            url:"../../redisDesktopManager/scan?tm="+ new Date().getTime(),
            type:"POST",
            data:{
                connectionKey:currentSelectConnection,
                dbIndex:currentDBIndex,
                key:key
            },
            dataType:"JSON",
            success:function (res) {
                if (res.code == 200) {
                    $("#keyDiv").html("");
                    var html = '';
                    $.each(res.data,function(i,temp){
                        var _cls = '';
                        if (i%2 == 0) {
                            _cls = 'color-bg-fa';
                        }
                       // html += '<tr><td>'+(i+1)+'</td><td '+_cls+'>'+temp+'</td></tr>';
                        html += '<div title="'+temp+'" onclick="loadKeyValue(\''+temp+'\',this)" class="col-md-12 col-sm-12 '+_cls+'" >'+temp+'</div>';
                    });
                    $("#keyDiv").html(html);
                }
            },error:function (res) {
                message.error();
            },complete(XHR, TS) {
                loadingClose();
            }
        });
    }

    function loadKeyValue(key,_this) {
        loading();
        $(".color-bg-e8f2ff").removeClass("color-bg-e8f2ff");
        $(_this).addClass("color-bg-e8f2ff");
        $.ajax({
            url:"../../redisDesktopManager/loadKeyValue?tm="+ new Date().getTime(),
            type:"POST",
            data:{
                connectionKey:currentSelectConnection,
                dbIndex:currentDBIndex,
                key:key
            },
            dataType:"JSON",
            success:function (res) {
                if (res.code == 200) {
                    var type = res.data.type;
                    $("#keyValueDiv").html("");
                    var html = '<div class="row">' +
                        '       <div class="col-md-12 col-sm-12">' +
                        '<table><tbody><tr>' +
                        '<td class="fontWeight900">'+type.toUpperCase()+'：</td>' +
                        '<td style="width: 100%;padding-right: 5px;"><input type="text" class="float-r" id="kv-key" style="width: 100%;" ></td>' +
                        '<td class="fontWeight900">TTL：</td>' +
                        '<td><input type="text" id="kv-ttl" class="float-r" style="width: 100px;" ></td>' +
                        '</tr></tbody></table>' +
                        '       </div>' +
                        '   </div>';
                    if ("string" == type) {
                        html += '<div class="row" style="margin-top: 10px">' +
                            '       <div class="col-md-12 col-sm-12">' +
                            '           <textarea id="kv-value" style="width: 100%;min-height: 360px;resize:none;" >'+res.data.data+'</textarea>' +
                            '       </div>' +
                            '   </div>';
                    } else if ("list" == type || "set" == type) {
                        html += '<div class="row" style="margin-top: 10px;">' +
                            '       <div class="col-md-12 col-sm-12">' +
                            '           <div class="kv-data-center-div kv-data-row">';
                        $.each(res.data.data,function(i,temp){
                            if (i%2 ==0) {
                                html += ('<div class="col-md-12 col-sm-12">'+temp+'</div>');
                            } else {
                                html += ('<div class="col-md-12 col-sm-12 color-bg-f5">'+temp+'</div>');
                            }
                        });
                        html += '   </div></div></div>';
                    } else if ("zset" == type) {
                        html += '<div class="row" style="margin-top: 10px">' +
                            '       <div class="col-md-12 col-sm-12"> <div class="kv-data-center-div kv-data-row">' +
                            '           <div class="col-md-9 col-sm-9">Value</div><div class="col-md-3 col-sm-3">Score</div>';
                        $.each(res.data.data,function(i,temp){
                            if (i%2 ==0) {
                                html += '<div class="col-md-9 col-sm-9">'+temp.element+'</div><div class="col-md-3 col-sm-3">'+temp.score+'</div>';
                            } else {
                                html += '<div class="col-md-9 col-sm-9 color-bg-f5">'+temp.element+'</div><div class="col-md-3 col-sm-3">'+temp.score+'</div>';
                            }
                        });
                        html += '       </div></div></div>';
                    } else if ("hash" == type) {
                        html += '   <div class="row" style="margin-top: 10px">' +
                            '       <div class="col-md-12 col-sm-12"><div class="kv-data-center-div">' +
                            '           <div class="col-md-4 col-sm-4">Key</div><div class="col-md-8 col-sm-8">Value</div>';
                        $.each(res.data.data,function(i,temp){
                            var cls = "";
                            if (i%2 !=0) {
                                cls = 'color-bg-f5';
                            }
                            for (var key in temp) {
                                html += '<div class="col-md-4 col-sm-4 kv-data-row '+cls+'">'+key+'</div><div class="col-md-8 col-sm-8 kv-data-row '+cls+'">'+temp[key]+'</div>';
                            }
                        });
                        html += '       </div></div>' +
                            '   </div>';
                    } else {

                    }
                    html += '   <div class="row" style="margin-top: 10px; text-align: right;">' +
                        '       <div class="col-md-12 col-sm-12">' +
                        '           <button id="kv-save" class="btn btn-primary">保存</button>' +
                        '       </div>' +
                        '   </div>';
                    $("#keyValueDiv").html(html);
                    $("#kv-key").val(res.data.key);
                    $("#kv-ttl").val(res.data.ttl);

                }
            },error:function (res) {
                message.error();
            },complete(XHR, TS) {
                loadingClose();
            }
        });
    }

    // 打开添加数据界面
    function openDataAdd(type,id){
        if (!strNotNull(currentSelectConnectionName)) {
            message.warning("请先选择连接");
            return;
        }
        if (!strNotNull(currentDBIndex)) {
            message.warning("请选择数据库");
            return;
        }
        layer.open({
            type: 2,
            title: "添加数据到【"+currentSelectConnectionName+":db"+currentDBIndex+"】",
            maxmin: true,
            // shadeClose: true, //点击遮罩关闭层
            area : ['800px' , '620px'],
            content: "redis_desktop_manager_data_add.html?csId="+currentSelectConnection+"&dbIndex="+currentDBIndex,
            end:function () {
                scan();
            }
        });
    }

    // 删除键
    function deleteKey() {
        var len = $(".color-bg-e8f2ff").length;
        if (len <= 0) {
            message.warning("请选择Key");
            return ;
        }
        var key = $(".color-bg-e8f2ff:eq(0)").html();
        var _i = layer.confirm('确认删除【'+key+'】吗？', {
            btn: ['确认', '取消']
        }, function(index, layero){
            loading();
            $.ajax({
                url:"../../redisDesktopManager/deleteKey?tm="+ new Date().getTime(),
                type:"POST",
                data:{
                    csId:currentSelectConnection,
                    dbIndex:currentDBIndex,
                    key:key
                },
                dataType:"JSON",
                success:function (res) {
                    if (res.code == 200) {
                        message.success();
                        $("#keyValueDiv").html("");
                        scan();
                    }
                },error:function (res) {
                    message.error();
                },complete(XHR, TS) {
                    loadingClose();
                    layer.close(_i);
                }
            });
        });

    }


</script>
</body>
</html>